rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if a user is an admin
    function isAdmin() {
      let adminDoc = get(/databases/$(database)/documents/admins/$(request.auth.uid));
      // Super admin check
      let isSuperAdmin = request.auth.token.email == "temahfingerofgod@gmail.com";
      // Regular admin check (exists and not expired)
      let isRegularAdmin = exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && 
                          (adminDoc.data.expiresAt == null || now() < timestamp.date(
                            adminDoc.data.expiresAt.year(), 
                            adminDoc.data.expiresAt.month(), 
                            adminDoc.data.expiresAt.day()
                          ));
      return isSuperAdmin || isRegularAdmin;
    }
    
    function isSuperAdmin() {
        return request.auth.token.email == "temahfingerofgod@gmail.com";
    }

    // Admins Collection: Only super admins can create/delete admins.
    match /admins/{userId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
    }

    // Site Settings: Readable by all, writable only by admins.
    match /site/{document=**} {
      allow read;
      allow write: if isAdmin();
    }

    // Products: Readable by all, writable only by admins.
    match /products/{productId} {
      allow read;
      allow write: if isAdmin();
    }

    // Orders:
    // - Users can create their own orders.
    // - Users can read their own orders.
    // - Admins can read and update any order.
    match /orders/{orderId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if (request.auth != null && resource.data.userId == request.auth.uid) || isAdmin();
      allow update: if isAdmin();
      allow delete: never; // Prevent accidental deletion of orders
    }

    // Default deny all other reads/writes
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
